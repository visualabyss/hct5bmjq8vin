
PURPOSE
  • Run OpenFace 3.0 on aligned crops to extract head pose (yaw/pitch via gaze), emotion (softmax + top label),
    and 8 Action Units (AU1,2,4,6,9,12,25,26). Optional detection if --skip_detect off.
  • Calibrate AU index mapping at runtime from reference images and cache to logs/openface3/au_info.json.
  • Outputs:
      - logs/openface3/openface3.csv (append unless --override): one row per image.
      - logs/openface3/per_image/<stem>.tsv: raw gaze (yaw,pitch), AU vector(8), emotion logits.
      - logs/openface3/au_info.json: AU mapping metadata.

USAGE (common)
  of3_py -u /workspace/scripts/openface3.py \
    --aligned /workspace/data_src/aligned \
    --logs    /workspace/data_src/logs \
    --of3_root /workspace/tools/OpenFace-3.0 \
    --device cuda --amp on --dtype bf16 --tf32 on \
    --skip_detect on --per_image on --override

CLI FLAGS
  # input / IO
  --aligned DIR (req)               images to process
  --logs DIR (req)                  log root
  --override (flag)                 overwrite CSV header if new schema; default off unless flag present

  # runtime / compute
  --device {cuda,cpu} (cuda)
  --amp on|off (on if cuda)
  --dtype {fp32,fp16,bf16} (bf16)
  --tf32 on|off (on)

  # detection
  --skip_detect on|off (on)
  --detector_resize FLOAT (1.0)
  --weights DIR (defaults: <of3_root>/weights)
  --of3_root DIR (req)

  # thresholds & behavior
  --th_smile FLOAT (0.5)
  --th_mouth FLOAT (0.5)
  --no_calib on|off (off)
  --calib_cache on|off (on)

  # extras (opt-in/off by default)
  --extra_csv on|off (off)          write openface3_full.csv with all 8 AU + optional emotion top-k
  --csv_emotion_topk INT (0)        0 disables; >0 writes top-k as label:prob pairs in extra CSV
  --landmarks on|off (off)          save landmarks per-image if available
  --landmarks_fmt {json,pts,both} (json)

  # logging & help
  --help on|off (on)                write /workspace/scripts/openface3.txt then proceed
  -h / --h                          print this help text and continue

LOG OUTPUT
  logs/openface3/openface3.csv      (append mode; header written if file is new)
  logs/openface3/per_image/*.tsv    (always written when --per_image on)
  logs/openface3/au_info.json       (AU mapping cache & metadata)
